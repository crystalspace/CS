<?xml version="1.0" encoding="utf-8" ?> 
<shader type="xmlshader" name="std_lighting">

<!--
<technique priority="150">
  <pass>
      <buffer name="vertices" destination="position" />
      <buffer name="colors" destination="primary color" />
      <buffer name="texture coordinates" destination="texture coordinate 0" />
      <texture name="tex diffuse" destination="unit 0" />
  </pass>
</technique>-->

    <technique priority="200">
      <pass>
	<?if vars."tex diffuse".texture ?>
	  <texture name="tex diffuse" destination="diffuse" />
	<?else?>
	  <!-- need to bind at least some texture -->
	  <texture name="standardtex white" destination="diffuse" />
	<?endif?>
	<?if vars."tex lightmap".texture ?>
	  <buffer source="texture coordinate lightmap" destination="texture coordinate lightmap" />
	  <texture name="tex lightmap" destination="lightmap" />
	<?endif?>
	<?if vars."fog density".float &gt; 0 ?>
	  <texture name="standardtex fog" destination="pea soup" />
	<?endif?>
	<vp plugin="glfixed">
	  <fixedvp>
	    <?if !vars."tex diffuse".texture ?>
	      <constantcolor layer="diffuse" type="shadervar">mat flatcolor</constantcolor>
	    <?endif?>
	    <?if vars."fog density".float &gt; 0 ?>
	      <texgen type="fog" layer="pea soup"/>
	      <constantcolor layer="pea soup" type="shadervar">fog color</constantcolor>
	    <?endif?>
	  </fixedvp>
	</vp>
	<fp plugin="glfixed">
	  <fixedfp>
	    <layer name="diffuse">
	      <?if vars."tex diffuse".texture ?>
		<colorsource num="0" source="texture" modifier="color"/>
		<alphasource num="0" source="texture" modifier="alpha"/>
	      <?else?>
		<colorsource num="0" source="constant color" modifier="color"/>
		<alphasource num="0" source="constant color" modifier="alpha"/>
	      <?endif?>
	      <?if !vars."tex lightmap".texture ?>
		<colorsource num="1" source="primary color" modifier="color"/>
		<coloroperation operation="modulate" />
		<alphasource num="1" source="primary color" modifier="alpha"/>
		<alphaoperation operation="modulate" />
	      <?else?>
		<coloroperation operation="replace" />
		<alphaoperation operation="replace" />
	      <?endif?>
	    </layer>
	    <?if vars."tex lightmap".texture ?>
	      <layer name="lightmap">
		<colorsource num="0" source="previous layer" modifier="color"/>
		<colorsource num="1" source="texture" modifier="color"/>
		<coloroperation operation="modulate" scale="2" />
		<alphasource num="0" source="previous layer" modifier="alpha"/>
		<alphaoperation operation="replace" />
	      </layer>
	    <?endif?>
	    <?if vars."fog density".float &gt; 0 ?>
	      <layer name="pea soup">
		<colorsource num="0" source="constant color" modifier="color"/>
		<colorsource num="1" source="previous layer" modifier="color"/>
		<colorsource num="2" source="texture" modifier="alpha"/>
		<coloroperation operation="interpolate" />
		<alphasource num="0" source="previous layer" modifier="alpha"/>
		<alphaoperation operation="replace"/>
	      </layer>
	    <?endif?>
	  </fixedfp>
	</fp>
      </pass>
    </technique>

    <technique priority="75">
      <pass>
	<buffer source="normal" destination="normal" />
	<texture name="tex diffuse" destination="unit 0" />
	<vp plugin="software" />
	<fp plugin="software" />
      </pass>
    </technique>
    <technique priority="50">
      <pass>     
        <?if !vars."tex diffuse".texture ?>
          <texture name="standardtex white" destination="unit 0" />
        <?else?>
          <texture name="tex diffuse" destination="unit 0" />
        <?endif?>
      </pass>
      <!-- @@@ Flat materials -->
      <?if vars."tex lightmap".texture ?>
        <pass>
            <mixmode><multiply2 /></mixmode><!-- @@@ probably not always desired -->
            <zmode><zmesh2 /></zmode>
            <buffer source="texture coordinate lightmap" destination="texture coordinate 0" />
            <texture name="tex lightmap" destination="unit 0" />
        </pass>
      <?endif?>
      <?if vars."fog density".float &gt; 0 ?>
        <pass>
          <mixmode><alpha /></mixmode><!-- @@@ probably not always desired -->
          <zmode><zmesh2 /></zmode>
          <texture name="standardtex fog" destination="unit 0" />
          <vp plugin="glfixed">
            <fixedvp>
              <texgen type="fog" layer="0"/>
              <constantcolor layer="0" type="shadervar">fog color</constantcolor>
            </fixedvp>
          </vp>
          <fp plugin="glfixed">
            <fixedfp>
              <layer>
                <colorsource num="0" source="constant color" modifier="color"/>
                <coloroperation operation="replace" />
                <alphasource num="0" source="texture" modifier="alpha"/>
                <alphaoperation operation="replace" />
              </layer>
            </fixedfp>
          </fp>
        </pass>
      <?endif?>
    </technique>
</shader>
